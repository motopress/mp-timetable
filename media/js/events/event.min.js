Registry.register("Event",function(t){"use strict";function e(){return{event_id:"",eventsData:{},init:function(){n.initTimePicker(),n.addEventButton(),n.initDeleteButtons(),n.initEditButtons(),n.initColorPicker(),n.initDatePicker(),n.columnRadioBox()},initTimePicker:function(){var e=Boolean(parseInt(t("#time_format").val()));t("#event_start").timepicker({showPeriod:e,showPeriodLabels:e,defaultTime:"00:00"}),t("#event_end").timepicker({showPeriod:e,showPeriodLabels:e,defaultTime:"00:00"})},initSlider:function(e,i){var a=_.isUndefined(i)?!1:Boolean(i),s=e.replace(/^\D+/g,"");t(e).carouFredSel({items:{visible:3},direction:"up",scroll:{items:1,easing:"swing",pauseOnHover:!0,onAfter:function(e){e.items.old.each(function(){t(this).removeClass("visible")}),e.items.visible.each(function(){t(this).addClass("visible")})}},auto:{play:a,timeoutDuration:3e3},prev:{button:"#mp_prev_button"+s},next:{button:"#mp_next_button"+s}}),t(e).trigger("currentVisible",function(t){t.addClass("visible")}),n.setColorSettings(e+" .mptt-colorized")},initColorPicker:function(e){_.isUndefined(e)&&(e="");var n=t(e+" input.clr-picker"),i=t(e+" input.regular-text");n.spectrum("destroy"),n.spectrum({preferredFormat:"rgb",showInput:!0,showAlpha:!0,allowEmpty:!0,palette:[["#000","#444","#666","#999","#ccc","#eee","#f3f3f3","#fff"],["#f00","#f90","#ff0","#0f0","#0ff","#00f","#90f","#f0f"],["#f4cccc","#fce5cd","#fff2cc","#d9ead3","#d0e0e3","#cfe2f3","#d9d2e9","#ead1dc"],["#ea9999","#f9cb9c","#ffe599","#b6d7a8","#a2c4c9","#9fc5e8","#b4a7d6","#d5a6bd"],["#e06666","#f6b26b","#ffd966","#93c47d","#76a5af","#6fa8dc","#8e7cc3","#c27ba0"],["#c00","#e69138","#f1c232","#6aa84f","#45818e","#3d85c6","#674ea7","#a64d79"],["#900","#b45f06","#bf9000","#38761d","#134f5c","#0b5394","#351c75","#741b47"],["#600","#783f04","#7f6000","#274e13","#0c343d","#073763","#20124d","#4c1130"]],showPalette:!0,show:function(e){t(this).val(e)},hide:function(){var e=t(this).parents(".select-color");e.find(".regular-text").val(t(this).val())},change:function(){var e=t(this).parents(".select-color");e.find('input:not([type="hidden"])').val(t(this).val())}}),i.off("keyup").on("keyup",function(){var e=t(this).parents(".select-color"),n=e.find(".clr-picker"),i=e.find(".regular-text").val(),a=e.find(".sp-preview-inner");a.css({"background-color":i}),n.spectrum("set",i)})},addEventButton:function(){t("#add_mp_event").off("click").on("click",function(){t(this).hasClass("edit")?n.updateEventData():(n.validateEventData(),n.validateEventData()&&n.renderEventItem())})},initDeleteButtons:function(){t("#events-list").find("#delete-event-button").off("click").on("click",function(){var e=t(this).attr("data-id");n.deleteEvent(e)})},initEditButtons:function(){t("#events-list").find("#edit-event-button").off("click").on("click",function(){var e=t(this).attr("data-id"),i=t(this).parent().parent();t(this).parent().find(".spinner").addClass("is-active"),Registry._get("adminFunctions").wpAjax({controller:"events",action:"get_event_data",id:e},function(e){var a=t("#add_mp_event"),s=t("#events-list");s.find(".spinner").removeClass("is-active"),s.find(" tr").removeClass("active"),i.addClass("active"),t("#event_start").val(e.event_start),t("#event_end").val(e.event_end),t("#description").val(e.description),t("#user_id").val(e.user_id),t("#weekday_id").val(e.column_id),a.addClass("edit"),a.val("Update"),n.event_id=e.id},function(t){console.warn(t)})})},deleteEvent:function(e){Registry._get("adminFunctions").wpAjax({controller:"events",action:"delete",id:e},function(){var n=t("#events-list").children('tr[data-id="'+e+'"]');n.length&&n.remove()},function(t){console.log(t)})},updateEventItem:function(){var e=t("#events-list").find('tr[data-id="'+n.event_id+'"]'),i=t("#user_id");e.find("td.event-column").text(t("#weekday_id").find("option:selected").text()),e.find("td.event-start").text(t("#event_start").val()),e.find("td.event-end").text(t("#event_end").val()),e.find("td.event-user-id").text("-1"===i.val()?"":i.find("option:selected").text()),e.find("td.event-description").text(t("#description").val()),n.event_id=null,t("#add_mp_event").removeClass("edit").val("Add Time Slot")},updateEventData:function(){var e=t("#add_event_table").find(".spinner");e.addClass("is-active"),Registry._get("adminFunctions").wpAjax({controller:"events",action:"update_event_data",data:{id:Registry._get("Event").event_id,event_start:t("#event_start").val(),event_end:t("#event_end").val(),description:t("#description").val(),user_id:t("#user_id").val(),weekday_ids:t("#weekday_id").val()}},function(){e.removeClass("is-active"),n.updateEventItem(),n.clearTable()},function(t){e.removeClass("is-active"),console.log(t)})},renderEventItem:function(){var e=t("#weekday_id"),i=t("#user_id"),a=e.find("option:selected").val(),s=t("#event_start"),d=t("#event_end"),o=t("#description"),r={tag:"tr",attrs:{},content:[{tag:"td",attrs:{style:"display:none;"},content:[{tag:"input",attrs:{type:"hidden",name:"event_data["+a+"][weekday_ids][]",value:a}},{tag:"input",attrs:{type:"hidden",name:"event_data["+a+"][event_start][]",value:s.val()}},{tag:"input",attrs:{type:"hidden",name:"event_data["+a+"][event_end][]",value:d.val()}},{tag:"input",attrs:{type:"hidden",name:"event_data["+a+"][description][]",value:o.val()}},{tag:"input",attrs:{type:"hidden",name:"event_data["+a+"][user_id][]",value:i.val()}}]},{tag:"td",attrs:{"class":"event-column"},content:[e.find("option:selected").text()]},{tag:"td",attrs:{"class":"event-start"},content:[s.val()]},{tag:"td",attrs:{"class":"event-end"},content:[d.val()]},{tag:"td",attrs:{"class":"event-description"},content:[o.val()]},{tag:"td",attrs:{"class":"event-user-id"},content:["-1"===i.val()?"":i.find("option:selected").text()]},{tag:"td",attrs:{},content:[]}]},c=Registry._get("adminFunctions").getHtml(r);t("#events-list").find("tbody").append(c),n.clearTable()},setColorSettings:function(e){_.isUndefined(e)&&(e=".mptt-colorized");var n=t(e);t.each(n,function(){var e=t(this);switch(e.attr("data-type")){case"column":case"event":e.hover(function(){var e=t(this).attr("data-bg_hover_color"),n=t(this).attr("data-hover_color");_.isEmpty(e)||t(this).css("background-color",e),_.isEmpty(n)||t(this).css("color",n);var i=t(this).parent().height(),a=t(this).height();i>a&&t(this).addClass("mptt-full-height")},function(){t(this).css("background-color",t(this).attr("data-bg_color")),t(this).css("color",t(this).attr("data-color")),t(this).removeClass("mptt-full-height")});break;case"widget":e.hover(function(){t(this).css("background-color",t(this).attr("data-background-hover-color")),t(this).css("color",t(this).attr("data-hover-color")),t(this).css("border-left-color",t(this).attr("data-hover-border-color"))},function(){t(this).css("background-color",t(this).attr("data-background-color")),t(this).css("color",t(this).attr("data-color")),t(this).css("border-left-color",t(this).attr("data-border-color"))})}})},validateEventData:function(){return!0},clearTable:function(){var e=t("#weekday_id");t("#add_event_table input:not(.button),#add_event_table textarea").val(""),e.val(e.find("option:first").attr("value"))},initDeleteButton:function(){var e=t("#events-list");e.find("li.event").find("i.operation-button.dashicons-no.dashicons").off("click").on("click",function(){e.find("li.event").length>1?t(this).parents("li.event").remove():e.remove()})},getRowspan:function(e){var n=[],i=[];t.each(e,function(e){var a=t(this).attr("data-start"),s=t(this).attr("data-end");i[e]=a,n[e]=s});var a=Math.min.apply(Math,i),s=Math.max.apply(Math,n),d=s-a;return 1>d?1:d},responsiveFilter:function(e){var n="#all",i=e.parents(".mptt-shortcode-wrapper");n=e.is("select")?e.val():e.attr("href").replace("#","");var a=i.find(".mptt-list-event");"#all"!==n?(a.hide(),i.find('.mptt-list-event[data-event-id="'+n+'"]').show()):a.show(),t.each(i.find(".mptt-column"),function(){t(this).show(),t(this).find(".mptt-list-event:visible").length<1&&t(this).hide()})},filterStatic:function(t){var e=t.parents(".mptt-shortcode-wrapper"),i="#all";i=t.is("select")?t.val():t.attr("href").replace("#","");var a=_.isEmpty(e.attr("id"))?"no-setup":e.attr("id");window.location.hash=a+":"+i,e.find("table").hide(),e.find('table[id="#'+i+'"]').fadeIn(),n.setEventHeight()},setEventHeight:function(){t.each(t(".mptt-shortcode-wrapper table td.event"),function(){var e=t(".mptt-event-container",t(this)),n=e.length,i=0,a=0;if(t("body").hasClass("mprm_ie")){var s=t(this).height();i=s/(n>0?n:1),t.each(e,function(){t(this).height(i+"px"),t(this).css("top",a+"px"),t(this).removeClass("mptt-hidden"),a+=i})}else i=100/(n>0?n:1),t.each(e,function(){t(this).height(i+"%"),t(this).css("top",a+"%"),t(this).removeClass("mptt-hidden"),a+=i})})},filterShortcodeEvents:function(){var e=t(".mptt-menu");e.length&&(t.each(t(".mptt-event-container"),function(){t(this).parents("td").addClass("event")}),n.setRowspanTd(),t("."+MPTT.table_class).data("hide_empty_row")&&n.hideEmptyRows(),e.off("change").on("change",function(){n.filterStatic(t(this)),n.responsiveFilter(t(this))}),t(".mptt-navigation-tabs.mptt-menu a").off("click").on("click",function(){var e=t(this);e.parents(".mptt-navigation-tabs.mptt-menu").find("li").removeClass("active"),e.parents("li").addClass("active"),n.filterStatic(e),n.responsiveFilter(e)}))},getFilterByHash:function(){var e=window.location.hash;if(!_.isUndefined(e)){var i=e.split(":"),a=i[0],s=i[1];t.each(t(".mptt-shortcode-wrapper"),function(e,n){var i=t(n),d="#"+i.attr("id");if(d===a)t(".mptt-menu").hasClass("mptt-navigation-tabs")?i.find(".mptt-navigation-tabs").find('a[href="#'+s+'"]').click():i.find(".mptt-navigation-select").val(s).change();else{var o=i.find('table[id="#all"]');o.fadeIn()}})}n.setEventHeight()},setRowspanTd:function(){t.each(t("."+MPTT.table_class+" td.event"),function(){var e=t(this).find(".mptt-event-container"),i=t(this).attr("data-column-id"),a=t(this).attr("data-row_height"),s=n.getRowspan(e),d=t(this).parents("."+MPTT.table_class);if(!_.isUndefined(s)&&s>1){var o=t(this).parents("tr").attr("data-index"),r=s+parseInt(o)-1;for(o;r>o;o++){var c=d.find("tr.mptt-shortcode-row-"+(parseInt(o)+1));if(c.length&&(c.find('td:not(.event)[data-column-id="'+i+'"]').remove(),c.find('td.event[data-column-id="'+i+'"]').length&&(s-=r-o,2>s))){s=1;break}}isNaN(a)||t(this).css("height",s*a)}t(this).attr("rowspan",s)})},hideEmptyRows:function(){var e=t("."+MPTT.table_class+" tbody tr"),n=t("."+MPTT.table_class).first().find("th").length;t.each(e,function(e,i){0===t(i).find("td.event").length&&t(i).find("td").length===n&&t(i).remove()})},displaySettings:function(){var e=t(".view_settings");e.length&&e.change(function(){if("all"===t(this).val()){t(this).attr("id");t(this).parents(".mptt-container").find(".next-days").css("display","block")}else t(this).parents(".mptt-container").find(".next-days").css("display","none")})},timeMode:function(e){e&&t("#"+e).change(function(){if("server"===t(this).val()){t(this).attr("id");t(this).parents(".mptt-container").find("."+t(this).attr("id")).css("display","block")}else t(this).parents(".mptt-container").find("."+t(this).attr("id")).css("display","none")})},initDatePicker:function(){var e=t("#datepicker");e.length&&e.datepicker({dateFormat:"d/m/yy",setDate:Date.parse(e.val())})},columnRadioBox:function(){var e=t("#datepicker"),n=t('input.option-input[name="column[column_option]"]'),i=t("select.mp-weekday");n.length&&n.on("change",function(){switch(t(this).val()){case"simple":i.prop("disabled",!0),e.prop("disabled",!0);break;case"weekday":i.prop("disabled",!1),e.val("").prop("disabled",!0);break;case"date":i.prop("disabled",!0),e.prop("disabled",!1)}})}}}var n;return{getInstance:function(){return n||(n=e()),n}}}(jQuery));
