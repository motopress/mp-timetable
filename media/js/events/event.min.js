Registry.register("Event",function(r){"use strict";var l;return{getInstance:function(){return l||(l={event_id:"",eventsData:{},init:function(){l.initTimePicker(),l.addEventButton(),l.initDeleteButtons(),l.initEditButtons(),l.initColorPicker(),l.initDatePicker(),l.columnRadioBox()},initTimePicker:function(){var t=Boolean(parseInt(r("#time_format").val()));r("#event_start").timepicker({showPeriod:t,showPeriodLabels:t,defaultTime:"00:00"}),r("#event_end").timepicker({showPeriod:t,showPeriodLabels:t,defaultTime:"00:00"})},initSlider:function(t,e){var n=!_.isUndefined(e)&&Boolean(e),a=t.replace(/^\D+/g,"");r(t).carouFredSel({items:{visible:3},direction:"up",scroll:{items:1,easing:"swing",pauseOnHover:!0,onAfter:function(t){t.items.old.each(function(){r(this).removeClass("visible")}),t.items.visible.each(function(){r(this).addClass("visible")})}},auto:{play:n,timeoutDuration:3e3},prev:{button:"#mp_prev_button"+a},next:{button:"#mp_next_button"+a}}),r(t).trigger("currentVisible",function(t){t.addClass("visible")}),l.setColorSettings(t+" .mptt-colorized")},initDeleteButton:function(){var t=r("#events-list");t.find("li.event").find("i.operation-button.dashicons-no.dashicons").off("click").on("click",function(){1<t.find("li.event").length?r(this).parents("li.event").remove():t.remove()})},initColorPicker:function(t){_.isUndefined(t)&&(t="");var e=r(t+" input.clr-picker"),n=r(t+" input.regular-text");e.spectrum("destroy"),e.spectrum({preferredFormat:"rgb",showInput:!0,showAlpha:!0,allowEmpty:!0,palette:[["#000","#444","#666","#999","#ccc","#eee","#f3f3f3","#fff"],["#f00","#f90","#ff0","#0f0","#0ff","#00f","#90f","#f0f"],["#f4cccc","#fce5cd","#fff2cc","#d9ead3","#d0e0e3","#cfe2f3","#d9d2e9","#ead1dc"],["#ea9999","#f9cb9c","#ffe599","#b6d7a8","#a2c4c9","#9fc5e8","#b4a7d6","#d5a6bd"],["#e06666","#f6b26b","#ffd966","#93c47d","#76a5af","#6fa8dc","#8e7cc3","#c27ba0"],["#c00","#e69138","#f1c232","#6aa84f","#45818e","#3d85c6","#674ea7","#a64d79"],["#900","#b45f06","#bf9000","#38761d","#134f5c","#0b5394","#351c75","#741b47"],["#600","#783f04","#7f6000","#274e13","#0c343d","#073763","#20124d","#4c1130"]],showPalette:!0,show:function(t){r(this).val(t)},hide:function(t){r(this).parents(".select-color").find(".regular-text").val(r(this).val())},change:function(t){r(this).parents(".select-color").find('input:not([type="hidden"])').val(r(this).val())}}),n.off("keyup").on("keyup",function(){var t=r(this).parents(".select-color"),e=t.find(".clr-picker"),n=t.find(".regular-text").val();t.find(".sp-preview-inner").css({"background-color":n}),e.spectrum("set",n)})},addEventButton:function(){r(document).on("click.admin","#add_mp_event",function(){r(this).hasClass("edit")?l.updateEventData():l.renderEventItem()})},initDeleteButtons:function(){r(document).on("click.admin","#events-list .delete-event-button",function(){var t=r(this).attr("data-id");l.deleteEvent(t)})},initEditButtons:function(){r(document).on("click.admin","#events-list .edit-event-button",function(){var t=r(this).attr("data-id"),a=r(this).parent().parent();r(this).parent().find(".spinner").addClass("is-active"),Registry._get("adminFunctions").wpAjax({controller:"events",action:"get_event_data",id:t},function(t){var e=r("#add_mp_event"),n=r("#events-list");n.find(".spinner").removeClass("is-active"),n.find(" tr").removeClass("active"),a.addClass("active"),r("#event_start").val(t.event_start),r("#event_end").val(t.event_end),r("#description").val(t.description),r("#user_id").val(t.user_id),r("#weekday_id").val(t.column_id),e.addClass("edit"),e.val("Update"),l.event_id=t.id},function(t){console.warn(t)})})},deleteEvent:function(n){Registry._get("adminFunctions").wpAjax({controller:"events",action:"delete",id:n},function(t){var e=r("#events-list").find('tr[data-id="'+n+'"]');e.length&&e.remove()},function(t){console.log(t)})},updateEventItem:function(){var t=r("#events-list").find('tr[data-id="'+l.event_id+'"]'),e=r("#user_id");t.find("td.event-column").text(r("#weekday_id").find("option:selected").text()),t.find("td.event-start").text(r("#event_start").val()),t.find("td.event-end").text(r("#event_end").val()),t.find("td.event-user-id").text("-1"===e.val()?"":e.find("option:selected").text()),t.find("td.event-description").text(r("#description").val()),l.event_id=null,r("#add_mp_event").removeClass("edit").val("Add New")},updateEventData:function(){var e=r("#add_event_table").find(".spinner");e.addClass("is-active"),Registry._get("adminFunctions").wpAjax({controller:"events",action:"update_event_data",data:{id:Registry._get("Event").event_id,event_start:r("#event_start").val(),event_end:r("#event_end").val(),description:r("#description").val(),user_id:r("#user_id").val(),weekday_ids:r("#weekday_id").val()}},function(){e.removeClass("is-active"),l.updateEventItem(),l.clearTable()},function(t){e.removeClass("is-active"),console.log(t)})},renderEventItem:function(){var t=r("#weekday_id"),e=r("#user_id"),n=t.find("option:selected").val(),a=r("#event_start"),i=r("#event_end"),s=r("#description"),d={tag:"tr",attrs:{},content:[{tag:"td",attrs:{style:"display:none;"},content:[{tag:"input",attrs:{type:"hidden",name:"event_data["+n+"][weekday_ids][]",value:n}},{tag:"input",attrs:{type:"hidden",name:"event_data["+n+"][event_start][]",value:a.val()}},{tag:"input",attrs:{type:"hidden",name:"event_data["+n+"][event_end][]",value:i.val()}},{tag:"input",attrs:{type:"hidden",name:"event_data["+n+"][description][]",value:s.val()}},{tag:"input",attrs:{type:"hidden",name:"event_data["+n+"][user_id][]",value:e.val()}}]},{tag:"td",attrs:{class:"event-column"},content:[t.find("option:selected").text()]},{tag:"td",attrs:{class:"event-start"},content:[a.val()]},{tag:"td",attrs:{class:"event-end"},content:[i.val()]},{tag:"td",attrs:{class:"event-description"},content:[s.val()]},{tag:"td",attrs:{class:"event-user-id"},content:["-1"===e.val()?"":e.find("option:selected").text()]},{tag:"td",attrs:{},content:[]}]},o=Registry._get("adminFunctions").getHtml(d);r("#events-list").find("tbody").append(o),r(".events-list-wrapper").scrollTop(1e10),l.clearTable()},setEventHeight:function(t){var e=t.parent().outerHeight(),n=r("body"),a=t.height(),i=t.data("min-height"),s=t.find(".mptt-inner-event-content").height();t.css("position","").css("width","").css("min-height",""),n.hasClass("mprm_ie_browser")?(s=t.css("height","").find(".mptt-inner-event-content").height(),t.height(a),s<=i?t.css("max-height",i):(t.css("height",""),t.css("max-height",s))):s<=i?t.css("min-height",i):t.css("min-height",s),e<a&&t.height(a)},recalculate_Height:function(t,e){var n=r(".mptt-event-container",t),a=n.length,i=0,s=0,d=t.height();r("body").hasClass("mprm_ie_browser")?(i=d/(0<a?a:1),_.isUndefined(e)?r.each(n,function(){var t=r(this);if(t.height(i),_.isEmpty(t.data("min-height"))){var e=t.height();0===e?t.data("min-height",i):t.data("min-height",e)}t.css("top",s+"px"),t.removeClass("mptt-hidden"),s+=i}):e.height(i)):(i=100/(0<a?a:1),_.isUndefined(e)?r.each(n,function(){var t=r(this);t.height(i+"%"),_.isEmpty(t.data("min-height"))&&t.data("min-height",t.height()),t.css("top",s+"%"),t.removeClass("mptt-hidden"),s+=i}):e.height(i+"%"))},setEventsHeight:function(){var t=r(".mptt-shortcode-wrapper").find("table").find("td.event");r.each(t,function(){var t=r(this);l.recalculate_Height(t)})},setColorSettings:function(t){_.isUndefined(t)&&(t=".mptt-colorized");var e=r(t);r.each(e,function(){var t=r(this),e=t.attr("data-bg_hover_color"),n=t.attr("data-hover_color"),a=t.parent();switch(t.attr("data-type")){case"column":case"event":t.hover(function(){_.isEmpty(e)||t.css("background-color",e),_.isEmpty(n)||t.css("color",n),l.setEventHeight(t)},function(){t.css("max-height","").css("min-height",""),l.recalculate_Height(a,t),t.css("background-color",t.attr("data-bg_color")),t.css("color",t.attr("data-color"))});break;case"widget":t.hover(function(){t.css("background-color",t.attr("data-background-hover-color")),t.css("color",r(this).attr("data-hover-color")),t.css("border-left-color",t.attr("data-hover-border-color"))},function(){t.css("background-color",t.attr("data-background-color")),t.css("color",t.attr("data-color")),t.css("border-left-color",t.attr("data-border-color"))})}})},clearTable:function(){var t=r("#weekday_id");r("#add_event_table input:not(.button),#add_event_table textarea").val(""),t.val(t.find("option:first").attr("value"))},getRowSpan:function(t){var a=[],i=[];r.each(t,function(t){var e=r(this).attr("data-start"),n=r(this).attr("data-end");i[t]=e,a[t]=n});var e=Math.min.apply(Math,i),n=Math.max.apply(Math,a)-e;return n<1?1:n},responsiveFilter:function(t){var e="all",n=t.parents(".mptt-shortcode-wrapper");e=t.is("select")?t.val():t.attr("href").replace("#","");var a=n.find(".mptt-list-event");"all"!==e?(a.hide(),n.find('.mptt-list-event[data-event-id="'+e+'"]').show()):a.show(),r.each(n.find(".mptt-column"),function(){r(this).show(),r(this).find(".mptt-list-event:visible").length<1&&r(this).hide()})},filterStatic:function(t){var e=t.parents(".mptt-shortcode-wrapper"),n="#all";n=t.is("select")?t.val():t.attr("href").replace("#","");var a=_.isEmpty(e.attr("id"))?"not-set":e.attr("id");window.location.hash=a+":"+n,e.find("table").hide(),e.find('table[id="#'+n+'"]').fadeIn(),l.setEventsHeight()},setClassTd:function(){r.each(r(".mptt-event-container"),function(){r(this).parents("td").addClass("event")})},initTableData:function(){l.setClassTd(),l.setRowSpanTd();var t="."+MPTT.table_class;r(t).data("hide_empty_row")&&l.hideEmptyRows()},filterShortcodeEvents:function(){var t=r(".mptt-menu");t.length&&(t.off("change").on("change",function(){l.filterStatic(r(this)),l.responsiveFilter(r(this))}),r(".mptt-navigation-tabs.mptt-menu a").off("click").on("click",function(){var t=r(this);t.parents(".mptt-navigation-tabs.mptt-menu").find("li").removeClass("active"),t.parents("li").addClass("active"),l.filterStatic(t),l.responsiveFilter(t)}))},showCurrentEvent:function(t,e){t.find(".mptt-menu").hasClass("mptt-navigation-tabs")?t.find(".mptt-navigation-tabs").find('a[href="#'+e+'"]').click():t.find(".mptt-menu").hasClass("mptt-navigation-select")&&t.find('.mptt-navigation-select option[value="'+e+'"]')?t.find(".mptt-navigation-select").val(e).change():t.find('table[id="#all"]').fadeIn()},getFilterByHash:function(){var t=window.location.hash;if(!_.isUndefined(t)){var e=t.split(":"),a=e[0],i=e[1],n=r(".mptt-shortcode-wrapper");i=_.isUndefined(i)?"all":i,1===n.length?l.showCurrentEvent(n,i):r.each(n,function(t,e){var n=r(e);"#"+n.attr("id")===a?l.showCurrentEvent(n,i):l.showCurrentEvent(n,"all")})}l.setEventsHeight()},removeCellsAfterChangeColSpan:function(t,e,n,a){for(;t<e;t++){var i=n.find('th[data-index="'+t+'"]').data("column-id");a.find('td:not(.event)[data-column-id="'+i+'"]').remove()}},removeCellsAfterChangeRowSpan:function(t,e,n,a){for(var i=t.parents("tr").attr("data-index"),s=e+parseInt(i)-1,d=t.attr("colspan"),o=n.find('th[data-column-id="'+a+'"]').data("index"),r=parseInt(o)+parseInt(d);i<s;i++){var c=n.find("tr.mptt-shortcode-row-"+(parseInt(i)+1));if(c.length){if(c.find('td.event[data-column-id="'+a+'"]').length&&(e-=s-i)<2){e=1;break}1<d&&l.removeCellsAfterChangeColSpan(o,r,n,c),c.find('td:not(.event)[data-column-id="'+a+'"]').remove()}}return e},setRowSpanTd:function(){var t="."+MPTT.table_class;r.each(r(t),function(){var s=r(this);r.each(s.find("td.event"),function(){var t=r(this),e=t.find(".mptt-event-container"),n=t.attr("data-column-id"),a=t.attr("data-row_height"),i=l.getRowSpan(e);!_.isUndefined(i)&&1<i&&(i=l.removeCellsAfterChangeRowSpan(t,i,s,n),isNaN(a)||t.css("height",i*a)),t.attr("rowspan",i)})})},hideEmptyRows:function(){var t="."+MPTT.table_class,e=r(t+" tbody tr"),n=r(t).first().find("th").length;r.each(e,function(t,e){0===r(e).find("td.event").length&&r(e).find("td").length===n&&r(e).remove()})},displaySettings:function(){var t=r(".view_settings");t.length&&t.change(function(){"all"===r(this).val()?(r(this).attr("id"),r(this).parents(".mptt-container").find(".next-days").css("display","block")):r(this).parents(".mptt-container").find(".next-days").css("display","none")})},timeMode:function(t){if(t){var e="."+r(this).attr("id");r("#"+t).change(function(){"server"===r(this).val()?(r(this).attr("id"),r(this).parents(".mptt-container").find(e).css("display","block")):r(this).parents(".mptt-container").find(e).css("display","none")})}},initDatePicker:function(){var t=r("#datepicker");t.length&&t.datepicker({dateFormat:"d/m/yy",setDate:Date.parse(t.val())})},columnRadioBox:function(){var t=r("#datepicker"),e=r('input.option-input[name="column[column_option]"]'),n=r("select.mp-weekday");e.length&&e.on("change",function(){switch(r(this).val()){case"simple":n.prop("disabled",!0),t.prop("disabled",!0);break;case"weekday":n.prop("disabled",!1),t.val("").prop("disabled",!0);break;case"date":n.prop("disabled",!0),t.prop("disabled",!1)}})}}),l}}}(jQuery));